!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).com=e.com||{},e.com.yindangu=e.com.yindangu||{},e.com.yindangu.vplatform=e.com.yindangu.vplatform||{},e.com.yindangu.vplatform.rule=e.com.yindangu.vplatform.rule||{},e.com.yindangu.vplatform.rule.client=e.com.yindangu.vplatform.rule.client||{},e.com.yindangu.vplatform.rule.client.addtablerecord={}))}(this,(function(e){"use strict";vds.import("vds.ds.*","vds.expression.*","vds.message.*","vds.window.*","vds.component.*","vds.log.*","vds.widget.*","vds.object.*");var t=["GenerateSequenceNumber","GenerateSequenceNumberQuick","GenerateUUID","GetSerialNumber","Random"];function r(e,t){this.dataSourceName=e,this.numCount=t}var n=function(e){var t=e;return-1!=e.indexOf(".")&&(t=e.split(".")[1]),t},o=function(e){if(e)for(var r=0,n=t.length;r<n;r++)if(-1!=e.indexOf(t[r]))return!0;return!1};r.prototype.insertRecords=function(e,t,r){for(var o=[],i=0;i<this.numCount;i++){for(var a=e.createRecord(),s=0;s<t.length;s++){var u=n(t[s].fieldName),d=t[s].value,l=t[s].context;l&&(d=vds.expression.execute(d,l)),a.set(u,d)}o.push(a)}var c=this.getActionMode(r,e);return e.insertRecords(o,c),o},r.prototype.getActionMode=function(e,t){var r;switch(e){case"0":r=t.Position.Before;break;case"1":r=t.Position.After;break;case"2":r=t.Position.Top;break;case"3":case"":r=null;break;default:vds.log.warn("[AddTableRecord.getActionMode]插入位置不正确,传入的actionMode:"+e+",自动适配成插入到最后"),r=null}return r};var i=function(e,t,r){var n=e,o=null;if(null==r||"window"==r)o=vds.ds.lookup(n);else{switch(r){case"ruleSetInput":n="BR_IN_PARENT."+n;break;case"ruleSetVar":n="BR_VAR_PARENT."+n;break;case"ruleSetOutput":n="BR_OUT_PARENT."+n}o=vds.expression.execute(n,{ruleContext:t})}if(!o)throw new Error("找不到参数中的实体！实体编码："+n);return o};e.main=function(e){return new Promise((function(t,a){var s=e.getVplatformInput(),u=s.NumCount,d=s.Mappings,l=s.MasterTable,c=s.TableName,f=s.TableType,v=s.AddLocation;v||(v="3");var p=i(c,e,f),g=vds.expression.execute(u,{ruleContext:e});if(isNaN(g))return vds.message.error("表达式执行结果不合法，请检查表达式！"),t();if(!(g<=0)){if(null==f||"window"==f)if(function(e){var t=!0,r=vds.widget.getWidgetCodes(e);if(!r||vds.object.isArray(r)&&r.length<=0)t=!1;else for(var n=0;n<r.length;n++){var o=vds.widget.getStoreType(r[n]);if(o==vds.widget.StoreType.Set||"menu"==o||"DataList"==o){t=!1;break}}return t}(c)&&(p.clear(!1),g>1))return vds.message.error("单值控件不允许一次插入多条数据！"),t();if(l)if(!vds.ds.lookup(l).getCurrentRecord())return vds.message.error("新增记录发生错误：关联父表没有选中记录！"),t();var m=new r(c,g),b=function(e,t,r){var i=[];if(!t||t.length<=0)return i;for(var a=0;a<t.length;a++){var s={},u=t[a].srcField,d=t[a].destField,l=t[a].fieldtype;if(s.fieldName=n(d),"1"===l){var c=e.getCurrentRecord();if(c){var f=u.substring(u.indexOf(".")+1,u.length);s.value=c.get(f)}}else if("2"===l)s.value=vds.component.getVariant(u);else if("3"===l)s.value=vds.window.getInput(u);else if("4"===l||"expression"===l){var v={ruleContext:r};o(u)?(s.context=v,s.value=u):s.value=vds.expression.execute(u,v)}i.push(s)}return i}(p,d,e);m.insertRecords(p,b,v),t()}}))},Object.defineProperty(e,"__esModule",{value:!0})}));
